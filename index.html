<!DOCTYPE html>
<html>
<head> 
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <style>
   
        .mapboxgl-popup {
          max-width: 500px;
          font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
          z-index: 10000;
        }
        #map {

        }
        
           #map {
            position:fixed;
            width:60%;
            top:0; 
            bottom:0; 
          }
          #features {
              width: 40%;
              margin-left: 60%;
              font-family: sans-serif;
              overflow-y: scroll;
              background-color: #fafafa;
          }
          section {
              padding:  25px 50px;
              line-height: 25px;
              border-bottom: 1px solid #ddd;
              opacity: 0.25;
              font-size: 13px;
          }
          section.active {
              opacity: 1;
          }
          section:last-child {
              border-bottom: none;
              margin-bottom: 200px;
          }
  
        .usaidpop h3 {
          padding: 0;
          margin: 0;
          margin-bottom:.5em;
        }
        .truncate {
            width: 480px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        div.outer-image {
          padding-bottom: 0.35em;
          display: inline-block;
        }
        .website-label {
          font: normal normal normal 13px/1.4em 'open sans',sans-serif;
          transition: color 0.4s ease 0s;
          color: #5272B2;
          display: inline-block;
          position: relative;
          white-space: nowrap;
          bottom: 12px;
        }
        .ym-links {
          text-align:center;
          display: inline-block;
        }
        .website-link {
          border: solid rgba(82, 114, 178, 1) 2px;
          cursor: pointer !important;
          padding-top:2em;
          padding-right: 1em;
          padding-left: 1em;
          display: block;
          margin-bottom: 4px;
        }
        div.center-cropped {
          background-position: center center;
          background-repeat: no-repeat;
          background-size: contain;
          width: auto;
          height: auto;
          min-height: 100px;
          min-width: 170px;
          display: inline-block;
          margin-right:0.5em;
        }
        
        div.chapter-interior {
          width: 500px;
          text-align: center;
        }
        .chapter-blurbs {
          padding-left: 1em;
          padding-right: 1em;
        }
        .chapter-blurbs h3 {
          display: inline;
        }
    </style>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.36.0/mapbox-gl.css' rel='stylesheet' />
      <script src='csv2geojson.js'></script>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>

  <script src="https://cdn.ravenjs.com/3.14.2/raven.min.js"></script>

</head>
<body>
<div id='map'></div>
  <div id="features">&nbsp;</div>
<script>
  //Raven.config('https://1a6e5463bde24c9ea2a9bf5f11200adb@sentry.io/162393').install()
window.isBusyAutoScrolling=true;

mapboxgl.accessToken = 'pk.eyJ1IjoidXNhaWRnZW9jZW50ZXIiLCJhIjoiY2lyMjk5eGlkMDMwdWZxbTh4dmx4Z2tvbyJ9.TC7ZUzMtmRYB9aQRFOg2FQ';
  
/* https://spreadsheets.google.com/feeds/list/13yswnN49P0dsO5BS2FJYaVUIjsnuWbzA3UxvhcLUsYI/1/public/values?alt=json */
  
var map = new mapboxgl.Map({
    container: 'map',
      pitch: 0.01,
    style: 'mapbox://styles/usaidgeocenter/cj3fzr28f000b2robnl5jfxsh',
    center: [-12, 15],
    zoom: 1.6
});
  
  
  var cleanID = function(str) {
    str = str.replace(/^\s+|\s+$/g, ''); // trim
  str = str.toLowerCase();

  // remove accents, swap ñ for n, etc
  var from = "àáäâèéëêìíïîòóöôùúüûñç·/_,:;";
  var to   = "aaaaeeeeiiiioooouuuunc------";

  for (var i=0, l=from.length ; i<l ; i++)
    str = str.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));


  str = str.replace(/[^a-z0-9 -]/g, '') // remove invalid chars
    .replace(/\s+/g, '-') // collapse whitespace and replace by -
    .replace(/-+/g, '-'); // collapse dashes
  return str;
}
  
  var getCSV = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Accept', 'text/plain');
    xhr.onerror = function(e) {
        callback(e);
    };
    xhr.onload = function() {
        if (xhr.status >= 200 && xhr.status < 300 && xhr.response) {
            var data;
            try {
                data = xhr.response;
            } catch (err) {
                return callback(err);
            }
            callback(null, data);
        } else {
            callback(new Error(xhr.statusText));
        }
    };
    xhr.send();
    return xhr;
};
  
  $(document).ready(function() {
    
      	var myUrl = 'https://youthmap-chapter-mapproxy.herokuapp.com/docs.google.com/spreadsheets/d/13yswnN49P0dsO5BS2FJYaVUIjsnuWbzA3UxvhcLUsYI/export?format=csv&id=13yswnN49P0dsO5BS2FJYaVUIjsnuWbzA3UxvhcLUsYI'
    
    getCSV(myUrl, makeGeoJSON);
});

function makeGeoJSON(err, csvData) {
  
    if (err) { console.log('⚠️ csv error!',err);  }

    csv2geojson.csv2geojson(csvData, {
        latfield: 'Latitude',
        lonfield: 'Longitude',
        delimiter: ','
    }, function(err, data) {
        var dataWithID = data;
         dataWithID.features = data.features && data.features.map(function(a,b) {
          var featureCopy = a;
          featureCopy.properties.id = cleanID(a.properties.School+"");      
          return featureCopy;
         });
      
      	var onDataAndMapLoaded = function () {
              console.log(dataWithID)
              map.addLayer({
                  'id': 'centers',
                  'type': 'symbol',
                  'source': {
                      'type': 'geojson',
                      'data': dataWithID
                  },
                  "layout": {
                  "text-size": 14,
                  "icon-offset": [
                      0,
                      0
                  ],
                  "icon-image": "ymmapmarker-green",
                  "text-font": [
                      "Avenir LT Std 35 Light",
                      "Open Sans Regular"
                  ],
                  "icon-allow-overlap": true,
                  "text-padding": 2,
                  "text-offset": [
                      0,
                      -0.6
                  ],
                  "icon-size": 0.3,
                  "text-anchor": "bottom",
                  "text-field": {
                      "base": 1,
                      "stops": [
                          [
                              0,
                              ""
                          ],
                          [
                              11,
                              "{School}"
                          ],
                          [
                              22,
                              "{School}"
                          ]
                      ]
                  }
              },
              "paint": {
                  "text-halo-color": "hsla(0, 0%, 25%, 0)",
                  "text-halo-blur": 3,
                  "text-color": "hsl(0, 0%, 20%)"
              }
              });

            var sections = document.getElementById('features');

            if (dataWithID.features.length) { 
              dataWithID.features.map(function (feature) {
              sections.innerHTML = "<section id='"+feature.properties.id+"'>"
                +templatize(feature.properties)+"</section>"+sections.innerHTML;
              });
            }
       		}
        if (map.loaded()) {
          onDataAndMapLoaded()
        } else {
          map.on('load', onDataAndMapLoaded);            /* end on map load */

        } /* end map loaded conditional */    
      

    });
}
  
  /*TODO: convert to React */
    var templatize = function(props) {
    if (props.School !== undefined) {
     input = props;
     univ = props.School;
     var websiteLink = ["<a class='website-link' target='new' href='"+input.FacebookWebsite+"'><span class='website-label'",(input.FacebookWebsite !== '' ? "" : ''), ">website</span></a> &nbsp; "].join('');
     var hiddenWebsiteLink = "<a class='website-link' target='new' href='' style='visibility: hidden'><span class='website-label'>hidden</span></a> &nbsp; ";
      var emailImg = "<img src='https://static.wixstatic.com/media/8d13be_830daf9636864597abb1e3cd19394261.gif' style='width: 40px; height: 40px; object-fit: contain;'/>"
      
    return [
      			"<div class='usaidpop'>",
      
      			"<h3 class='truncate' title='",univ,"'>",
      				univ," : ",input.PlaceName,
      			"</h3>",
      
            "<div class='chapter-interior'>",
              "<div style='background-image:url(",input.Image,");' class='center-cropped'></div>",
      
              "<div class='ym-links'>",
                (input.FacebookWebsite !== '' ? websiteLink
                    : hiddenWebsiteLink),
                "<a target='new' href='",input.ContactURL,"'>",
                emailImg,
                "</a>",
              "</div>",
      			"</div>",
      
      			"<div class='chapter-blurbs'>",
              "<h3 class='truncate'>",
              input.ChapterName,
              "</h3>&nbsp;",
              input.blurbs,
      			"</div>",
      
            "</div>"
           ].join('');
    } else {
      console.log(props)
      return "Unrecognized"
    }
  }
    
 // On every scroll event, check which element is on screen
window.onscroll = function() {
  if (!window.isBusyAutoScrolling) {
    var features = map.queryRenderedFeatures( { layers: ['centers'] }) || [];

      var chapterNames = features.map(function(a) {
        return cleanID(a.properties.School)
      });
      for (var i = 0; i < chapterNames.length; i++) {
          var chapterName = chapterNames[i];

          if (isElementOnScreen(chapterName)) {
              setActiveChapter(chapterName);
              break;
          } else if (window.isBusyAutoScrolling) {
            console.log('was scrolling, skipped active chapter');
          }
      }
  }
};

  var activeChapterName = 'university-of-california-davis';
function setActiveChapter(chapterName) {
    if (chapterName === activeChapterName) return;
  var featuresList = map.queryRenderedFeatures( { layers: ['centers'] }) || [];

    map.flyTo({center:
featuresList.find(function(a) {return a.properties.id === chapterName}).geometry.coordinates, zoom: 4});

 document.getElementById(chapterName).setAttribute('class', 'active');
    document.getElementById(activeChapterName).setAttribute('class', '');

    activeChapterName = chapterName;
}

function isElementOnScreen(id) {
    var element = document.getElementById(id) || document.getElementById(activeChapterName);
    var bounds = element.getBoundingClientRect();
    return bounds.top < window.innerHeight && bounds.bottom > 0;
}
  
 //https://docs.google.com/spreadsheets/d/13yswnN49P0dsO5BS2FJYaVUIjsnuWbzA3UxvhcLUsYI/export?format=csv&id=13yswnN49P0dsO5BS2FJYaVUIjsnuWbzA3UxvhcLUsYI

  // Create a popup, but don't add it to the map yet.
  var markerHeight = 50, markerRadius = 15, linearOffset = 510;
var popupOffsets = {
 'top': [0, 0],
 'top-left': [0,0],
 'top-right': [0,0],
 'bottom': [0, -markerHeight],
 'bottom-left': [linearOffset, (markerHeight - markerRadius + linearOffset) * -1],
 'bottom-right': [-linearOffset, (markerHeight - markerRadius + linearOffset) * -1],
 'left': [markerRadius, (markerHeight - markerRadius) * -1],
 'right': [-markerRadius, (markerHeight - markerRadius) * -1]
 };
var hoverPopup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: true,
    offsets: popupOffsets
});
  window.pop = hoverPopup;
  
  map.on('mousemove', function (e) {/ *  */
    var features = map.queryRenderedFeatures(e.point, { layers: ['centers']  });
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';

  });
  
  // Use the same approach as above to indicate that the symbols are clickable
// by changing the cursor style to 'pointer'.
map.on('click', function (e) {/ *  */
    var features = map.queryRenderedFeatures(e.point, { layers: ['centers']  });
    var feature = features && features[0] && features[0].properties && features[0].properties.id;
    if (feature !== undefined) {  
     	window.isBusyAutoScrolling=true;
      console.log(feature);
   		$('body,html').animate({
    		scrollTop: $("#"+feature).offset().top
}, 1000);
      setActiveChapter(feature);
      window.setTimeout(function() {
        window.isBusyAutoScrolling=false;
      }, 1050)
      	

    }
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';


    /*if (!features && !features.length) {
      hoverPopup.remove();
      return;
    }
  
  if (feature && feature.properties && feature.properties.type !== 'country' && feature.properties.type !== 'state') {	hoverPopup.setLngLat(feature.geometry.coordinates)
       .setHTML(templatize(feature.properties))
        .addTo(map);
  }*/
});
  map.addControl(new mapboxgl.NavigationControl());
</script>

</body>
</html>